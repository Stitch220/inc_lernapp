<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Teacher Chat</title>
    <link rel="stylesheet" href="/static/css/style.css">
    <link rel="stylesheet" href="/static/css/teacher.css">
    <script src="/static/js/logout.js" defer></script>
</head>
<body>
    <h1>Welcome, {{ teacher }}</h1>
    <button id="logout-button">Logout</button>

    <h2>Select a Student</h2>
    <form method="GET" action="/teacher">
        <label for="student">Select Student:</label>
        <select name="student" id="student" onchange="this.form.submit()">
            <option value="" disabled {% if not selected_student %}selected{% endif %}>Select a student</option>
            {% for student in students %}
            <option value="{{ student }}" {% if student == selected_student %}selected{% endif %}>
                {{ student }}
            </option>
            {% endfor %}
        </select>
    </form>

    {% if archived_chats %}
    <h2>Archived Chats</h2>
    <form method="GET" action="/teacher">
        <label for="archived-chat">Select Archived Chat:</label>
        <select name="archived_chat" id="archived-chat" onchange="this.form.submit()">
            <option value="" disabled {% if not selected_archived_chat_id %}selected{% endif %}>Select an archived chat</option>
            {% for id, title in archived_chats %}
            <option value="{{ id }}" {% if id == selected_archived_chat_id %}selected{% endif %}>
                {{ title }}
            </option>
            {% endfor %}
        </select>
    </form>
    
    {% endif %}

    {% if selected_student or selected_archived_chat %}
        <h2>Chat with {{ selected_student if selected_student else archived_chat_student }}</h2>
        <div id="chat-history">
            {% if chats %}
                {% for message, sender, timestamp in chats %}
                <div class="chat-message {{ 'sent' if sender == 'teacher' else 'received' }}">
                    <p><strong>{{ 'You' if sender == 'teacher' else (selected_student if selected_student else archived_chat_student) }}:</strong> {{ message }}</p>
                    <span class="timestamp">{{ timestamp }}</span>
                </div>
                {% endfor %}
            {% else %}
                <p>No messages yet. Start the conversation!</p>
            {% endif %}
        </div>

        {% if not archived %}
            <h2>Send a Message</h2>
            <form method="POST" action="/teacher?student={{ selected_student }}">
                <label for="message">Message:</label>
                <textarea name="message" id="message" rows="4" required></textarea>
                <button type="submit">Send</button>
            </form>
            <form method="POST" action="/end_chat" onsubmit="return getChatTitle()">
                <input type="hidden" name="other_user" value="{{ selected_student }}">
                <input type="hidden" id="chat-title-input" name="chat_title">
                <button type="submit" class="end-chat-button">End Chat</button>
            </form>
        {% else %}
            <p>This chat has been archived. You can no longer send messages.</p>
        {% endif %}
    {% endif %}

    <script>
        function getChatTitle() {
            const title = prompt("Please enter a title for this chat:");
            if (!title) {
                alert("You must enter a title to archive the chat.");
                return false;
            }
            document.getElementById('chat-title-input').value = title;
            return true;
        }
    </script>
</body>
</html>
